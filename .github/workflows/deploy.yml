name: Deploy to GitHub Pages

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    - name: Prepare deployment
      run: |
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}
        echo "üîÑ Deploying version: v$VERSION"
        
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –≤–µ—Ä—Å–∏–∏
        mkdir -p "v$VERSION"
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
        cp -r ru en index.html "v$VERSION/"
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç–∏ –≤ HTML —Ñ–∞–π–ª–∞—Ö
        find "v$VERSION" -name "*.html" -exec sed -i 's|href="../|href="/dsa-lab4/v$VERSION/|g' {} \;
        find "v$VERSION" -name "*.html" -exec sed -i 's|href="ru/|href="/dsa-lab4/v$VERSION/ru/|g' {} \;
        find "v$VERSION" -name "*.html" -exec sed -i 's|href="en/|href="/dsa-lab4/v$VERSION/en/|g' {} \;
        
    - name: Deploy to gh-pages
      run: |
        git fetch origin gh-pages
        git checkout gh-pages
        
        # –ö–æ–ø–∏—Ä—É–µ–º –ø–∞–ø–∫—É —Å –≤–µ—Ä—Å–∏–µ–π
        cp -r "v${{ github.ref_name#v }}"/* .
        
        git add .
        git commit -m "üöÄ Deploy ${{ github.ref_name }}" || echo "No changes"
        git push origin gh-pages