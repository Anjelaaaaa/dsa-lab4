name: Deploy to GitHub Pages

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout and deploy
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: gh-pages
        fetch-depth: 0
        
    - name: Setup Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    - name: Create version from main
      run: |
        VERSION="${{ github.ref_name }}"
        echo "üöÄ Creating version: $VERSION"
        
        # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª—ã –∏–∑ main –≤–µ—Ç–∫–∏
        git fetch origin main
        git checkout origin/main -- index.html ru en
        
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –≤–µ—Ä—Å–∏–∏
        mkdir -p "$VERSION"
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É –≤–µ—Ä—Å–∏–∏
        cp -r index.html ru en "$VERSION"/
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç–∏ –≤ HTML —Ñ–∞–π–ª–∞—Ö –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ–π –ø–∞–ø–∫–∏
        find "$VERSION" -name "*.html" -exec sed -i "s|href=\"/dsa-lab4/|href=\"/dsa-lab4/$VERSION/|g" {} \;
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–ø–∏—é –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        cp index.html index_template.html
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É - –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
        sed -i "/<strong>–ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è:<\/strong>/c\\            
        <p><strong>–ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è:</strong> <a href=\"$VERSION/\">$VERSION</a></p>" index.html
        sed -i "/<strong>–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–µ—Ä—Å–∏–∏:<\/strong>/a\\                
        <li><a href=\"$VERSION/\">$VERSION</a></li>" index.html
        
        echo "Version $VERSION added to main page"
        
        git add .
        git commit -m "Deploy $VERSION and update version list" || echo "No changes to commit"
        git push origin gh-pages
        echo "Successfully deployed $VERSION"