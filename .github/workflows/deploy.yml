name: Deploy to GitHub Pages

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    - name: Get version and prepare deployment
      run: |
        # –ü–†–ê–í–ò–õ–¨–ù–û–ï –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ —Ç–µ–≥–∞
        VERSION=${{ github.ref_name }}
        # –£–±–∏—Ä–∞–µ–º 'v' –∏–∑ –Ω–∞—á–∞–ª–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
        VERSION=${VERSION#v}
        echo "üîÑ Deploying version: v$VERSION"
        echo "GitHub Ref: ${{ github.ref }}"
        echo "GitHub Ref Name: ${{ github.ref_name }}"
        
        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –≤–µ—Ä—Å–∏–∏
        mkdir -p "deploy/v$VERSION"
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ –≤–µ—Ä—Å–∏–æ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        cp -r ru en index.html "deploy/v$VERSION/"
        
        echo "üìÅ Files copied to deploy/v$VERSION"
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç–∏ –≤ HTML —Ñ–∞–π–ª–∞—Ö –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
        find "deploy/v$VERSION" -name "*.html" -exec sed -i 's|href="../|href="/dsa-lab4/v$VERSION/|g' {} \;
        find "deploy/v$VERSION" -name "*.html" -exec sed -i 's|href="ru/|href="/dsa-lab4/v$VERSION/ru/|g' {} \;
        find "deploy/v$VERSION" -name "*.html" -exec sed -i 's|href="en/|href="/dsa-lab4/v$VERSION/en/|g' {} \;
        
        echo "‚úÖ Paths updated for version v$VERSION"
        
    - name: Deploy to gh-pages branch
      run: |
        echo "üöÄ Starting deployment to gh-pages..."
        git fetch origin gh-pages
        git checkout gh-pages
        
        # –ö–æ–ø–∏—Ä—É–µ–º –í–°–Æ –ø–∞–ø–∫—É deploy, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–µ—Ä—Å–∏–∏
        cp -r deploy/* .
        
        echo "üìã Current structure:"
        ls -la
        
        git add .
        git status
        git commit -m "üöÄ Deploy version v$VERSION" || echo "No changes to commit"
        git push origin gh-pages
        echo "üéâ Successfully deployed v$VERSION"